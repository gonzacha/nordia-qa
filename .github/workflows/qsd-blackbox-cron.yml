name: qsd-blackbox-cron

on:
  schedule:
    - cron: "0 * * * *" # every 1 hour
  workflow_dispatch:

jobs:
  qsd_blackbox:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      BASE_URL: https://qsd-seven.vercel.app
      CAT: corrientes
      LIMIT: "10"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show tool versions
        run: |
          bash --version
          curl --version
          jq --version

      - name: Run QSD blackbox module
        id: run
        run: |
          set -o pipefail
          mkdir -p out
          ./scripts/qsd_module.sh | tee out/qsd_module.json | jq .
          echo "ok=true" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qsd_module_json
          path: out/qsd_module.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Notify Discord on FAIL
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set; skipping notification."
            exit 0
          fi

          payload="$(cat out/qsd_module.json | jq -c '.')"

          msg=$(jq -nc \
            --arg content "ðŸš¨ QSD Blackbox FAIL â€” ${BASE_URL} cat=${CAT} (see artifact in Actions run)" \
            --argjson data "$payload" \
            '{content:$content}')

          curl -sS -X POST -H "Content-Type: application/json" \
            -d "$msg" \
            "$DISCORD_WEBHOOK_URL" >/dev/null
