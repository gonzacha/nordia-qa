name: qsd-blackbox-cron

on:
  schedule:
    - cron: "0 * * * *" # every 1 hour
  workflow_dispatch:

jobs:
  qsd_blackbox:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      BASE_URL: https://qsd-seven.vercel.app
      CAT: corrientes
      LIMIT: "10"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show tool versions
        run: |
          bash --version
          curl --version
          jq --version

      - name: Run QSD blackbox module
        id: run
        run: |
          set -o pipefail
          mkdir -p out
          set +e
          ./scripts/qsd_module.sh > out/qsd_module.json
          exit_code=$?
          set -e
          cat out/qsd_module.json | jq .
          echo "exit_code=${exit_code}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qsd_module_json
          path: out/qsd_module.json
          if-no-files-found: ignore
          retention-days: 7

      - name: Checkout qa-ledger branch
        uses: actions/checkout@v4
        with:
          ref: qa-ledger
          path: qa-workspace

      - name: Enrich + append to ledger
        run: |
          mkdir -p qa-workspace/data
          touch qa-workspace/data/qa_history.jsonl
          ENRICHED_JSON="$(bash scripts/qsd_observability.sh "$(cat out/qsd_module.json)" "qa-workspace/data/qa_history.jsonl")"
          echo "$ENRICHED_JSON" >> qa-workspace/data/qa_history.jsonl
          tail -n 168 qa-workspace/data/qa_history.jsonl > qa-workspace/data/.tmp
          mv qa-workspace/data/.tmp qa-workspace/data/qa_history.jsonl
          echo "$ENRICHED_JSON" > out/qsd_observability.json

      - name: Commit ledger
        run: |
          git -C qa-workspace config user.name "QSD Bot"
          git -C qa-workspace config user.email "qsd-bot@noreply"
          git -C qa-workspace add data/qa_history.jsonl
          if git -C qa-workspace diff --cached --quiet; then
            echo "no changes"
          else
            git -C qa-workspace commit -m "chore: append QA observability run [skip ci]"
          fi
          git -C qa-workspace pull --rebase origin qa-ledger || true
          git -C qa-workspace push origin qa-ledger || git -C qa-workspace push origin qa-ledger

      - name: Notify Discord on state transition
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "${DISCORD_WEBHOOK_URL}" ]; then
            echo "DISCORD_WEBHOOK_URL secret not set; skipping notification."
            exit 0
          fi

          payload="$(cat out/qsd_observability.json | jq -c '.')"
          alert="$(echo "$payload" | jq -r '.observability.alert // "NONE"')"

          if [ "$alert" = "NONE" ]; then
            echo "no alert"
            exit 0
          fi

          if [ "$alert" = "ENTER_RED" ]; then
            content="ðŸš¨ QSD Blackbox RED â€” ${BASE_URL} cat=${CAT} (see artifact in Actions run)"
          elif [ "$alert" = "ENTER_ORANGE" ]; then
            content="ðŸŸ  QSD Blackbox ORANGE â€” ${BASE_URL} cat=${CAT} (see artifact in Actions run)"
          elif [ "$alert" = "RECOVERY" ]; then
            content="âœ… QSD Blackbox RECOVERY â€” ${BASE_URL} cat=${CAT} (see artifact in Actions run)"
          else
            content="â„¹ï¸ QSD Blackbox Update â€” ${BASE_URL} cat=${CAT} (see artifact in Actions run)"
          fi

          msg=$(jq -nc \
            --arg content "$content" \
            --argjson data "$payload" \
            '{content:$content}')

          curl -sS -X POST -H "Content-Type: application/json" \
            -d "$msg" \
            "$DISCORD_WEBHOOK_URL" >/dev/null
